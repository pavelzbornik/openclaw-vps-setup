---
# Main playbook for OpenClaw VM provisioning
# Usage: ansible-playbook -i inventory/hosts.yml site.yml

- name: Provision OpenClaw VM
  hosts: openclaw_vms
  become: true

  pre_tasks:
    - name: Display target host information
      debug:
        msg: |
          Provisioning OpenClaw on host: {{ inventory_hostname }}
          IP Address: {{ ansible_host }}
          User: {{ ansible_user }}
      tags:
        - always

    - name: Wait for system to be ready
      wait_for_connection:
        timeout: 300
      tags:
        - always

    - name: Gather facts
      setup:
      tags:
        - always

    - name: Display system information
      debug:
        msg: |
          OS: {{ ansible_distribution }} {{ ansible_distribution_version }}
          Kernel: {{ ansible_kernel }}
          Architecture: {{ ansible_architecture }}
          Python: {{ ansible_python_version }}
      tags:
        - always

  roles:
    - role: openclaw_vendor_base
      tags:
        - vendor
        - base

    - role: common
      tags:
        - common
        - base

    - role: onepassword
      tags:
        - onepassword
        - secrets
        - 1password

    - role: openclaw
      tags:
        - openclaw
        - app

  post_tasks:
    - name: Verify OpenClaw installation
      stat:
        path: "{{ openclaw_home }}/.npm-global/bin/openclaw"
      register: openclaw_verify
      tags:
        - always

    - name: Display OpenClaw installation status
      debug:
        msg: "OpenClaw successfully installed at {{ openclaw_home }}/.npm-global/bin/openclaw"
      when: openclaw_verify.stat.exists
      tags:
        - always

    - name: Check OpenClaw service status
      systemd:
        name: openclaw
      register: openclaw_service
      tags:
        - always

    - name: Display OpenClaw service status
      debug:
        msg: |
          Service: {{ openclaw_service.name }}
          State: {{ openclaw_service.status.ActiveState }}
          Enabled: {{ 'yes' if openclaw_service.status.UnitFileState == 'enabled' else 'no' }}
      when: openclaw_service is defined
      tags:
        - always

    - name: Display next steps
      debug:
        msg: "OpenClaw provisioning complete. See README for next steps."
      tags:
        - always
