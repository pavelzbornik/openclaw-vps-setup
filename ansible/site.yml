---
# Main playbook for OpenClaw VM provisioning
# Usage: ansible-playbook -i inventory/hosts.yml site.yml

- name: Provision OpenClaw VM
  hosts: openclaw_vms
  become: true

  pre_tasks:
    - name: Load optional vaulted variables
      include_vars:
        file: "{{ playbook_dir }}/group_vars/vault.yml"
      no_log: true
      when: lookup('ansible.builtin.fileglob', playbook_dir + '/group_vars/vault.yml', errors='ignore') | length > 0
      tags:
        - always

    - name: Retrieve Tailscale auth key from 1Password
      command: op read "op://OpenClaw/Tailscale/credential"
      delegate_to: localhost
      run_once: true
      become: false
      no_log: true
      register: tailscale_authkey_op
      environment:
        OP_SERVICE_ACCOUNT_TOKEN: "{{ openclaw_op_service_account_token }}"
      changed_when: false
      failed_when: false
      when:
        - tailscale_enabled | default(false)
        - openclaw_op_service_account_token | length > 0
      tags:
        - always

    - name: Set tailscale_authkey from 1Password (skipped if placeholder or missing)
      set_fact:
        tailscale_authkey: "{{ tailscale_authkey_op.stdout | trim }}"
      when:
        - tailscale_authkey_op is not skipped
        - tailscale_authkey_op.rc | default(1) == 0
        - tailscale_authkey_op.stdout | default('') | trim | length > 0
        - "'PLACEHOLDER' not in (tailscale_authkey_op.stdout | default(''))"
      no_log: true
      tags:
        - always

    - name: Fetch Discord allowlist from 1Password
      command: >-
        op read
        "op://{{ openclaw_discord_config_vault }}/{{ openclaw_discord_config_item }}/{{ openclaw_discord_config_allowlist_field }}"
      delegate_to: localhost
      run_once: true
      become: false
      no_log: true
      register: discord_allowlist_op
      environment:
        OP_SERVICE_ACCOUNT_TOKEN: "{{ openclaw_op_service_account_token }}"
      changed_when: false
      failed_when: false
      when: openclaw_op_service_account_token | length > 0
      tags:
        - always

    - name: Set vault_openclaw_discord_allowlist from 1Password
      set_fact:
        vault_openclaw_discord_allowlist: >-
          {{ discord_allowlist_op.stdout | trim | split(',') | map('trim') | list }}
      when:
        - discord_allowlist_op is not skipped
        - discord_allowlist_op.rc | default(1) == 0
        - discord_allowlist_op.stdout | default('') | trim | length > 0
      tags:
        - always

    - name: Fetch Discord guilds from 1Password
      command: >-
        op read
        "op://{{ openclaw_discord_config_vault }}/{{ openclaw_discord_config_item }}/{{ openclaw_discord_config_guilds_field }}"
      delegate_to: localhost
      run_once: true
      become: false
      no_log: true
      register: discord_guilds_op
      environment:
        OP_SERVICE_ACCOUNT_TOKEN: "{{ openclaw_op_service_account_token }}"
      changed_when: false
      failed_when: false
      when: openclaw_op_service_account_token | length > 0
      tags:
        - always

    - name: Set vault_openclaw_discord_guilds from 1Password
      set_fact:
        vault_openclaw_discord_guilds: >-
          {{ discord_guilds_op.stdout | trim | split(',') | map('trim') | list }}
      when:
        - discord_guilds_op is not skipped
        - discord_guilds_op.rc | default(1) == 0
        - discord_guilds_op.stdout | default('') | trim | length > 0
      tags:
        - always

    - name: Fetch IDENTITY.md content from 1Password
      command: >-
        op read
        "op://{{ openclaw_content_vault }}/{{ openclaw_content_item }}/{{ openclaw_content_identity_md_field }}"
      delegate_to: localhost
      run_once: true
      become: false
      no_log: true
      register: identity_md_op
      environment:
        OP_SERVICE_ACCOUNT_TOKEN: "{{ openclaw_op_service_account_token }}"
      changed_when: false
      failed_when: false
      when: openclaw_op_service_account_token | length > 0
      tags:
        - always

    - name: Set vault_openclaw_identity_md from 1Password
      set_fact:
        vault_openclaw_identity_md: "{{ identity_md_op.stdout }}"
      when:
        - identity_md_op is not skipped
        - identity_md_op.rc | default(1) == 0
        - identity_md_op.stdout | default('') | trim | length > 0
      tags:
        - always

    - name: Fetch USER.md content from 1Password
      command: >-
        op read
        "op://{{ openclaw_content_vault }}/{{ openclaw_content_item }}/{{ openclaw_content_user_md_field }}"
      delegate_to: localhost
      run_once: true
      become: false
      no_log: true
      register: user_md_op
      environment:
        OP_SERVICE_ACCOUNT_TOKEN: "{{ openclaw_op_service_account_token }}"
      changed_when: false
      failed_when: false
      when: openclaw_op_service_account_token | length > 0
      tags:
        - always

    - name: Set vault_openclaw_user_md from 1Password
      set_fact:
        vault_openclaw_user_md: "{{ user_md_op.stdout }}"
      when:
        - user_md_op is not skipped
        - user_md_op.rc | default(1) == 0
        - user_md_op.stdout | default('') | trim | length > 0
      tags:
        - always

    - name: Display target host information
      debug:
        msg: |
          Provisioning OpenClaw on host: {{ inventory_hostname }}
          IP Address: {{ ansible_host }}
          User: {{ ansible_user }}
      tags:
        - always

    - name: Wait for system to be ready
      wait_for_connection:
        timeout: 300
      tags:
        - always

    - name: Gather facts
      setup:
      tags:
        - always

    - name: Display system information
      debug:
        msg: |
          OS: {{ ansible_distribution }} {{ ansible_distribution_version }}
          Kernel: {{ ansible_kernel }}
          Architecture: {{ ansible_architecture }}
          Python: {{ ansible_python_version }}
      tags:
        - always

  roles:
    - role: openclaw_vendor_base
      tags:
        - vendor
        - base

    - role: common
      tags:
        - common
        - base

    - role: onepassword
      tags:
        - onepassword
        - secrets
        - 1password

    - role: openclaw_config
      tags:
        - openclaw
        - config

    - role: openclaw_gateway_proxy
      tags:
        - openclaw
        - gateway
        - nginx
        - lan

  post_tasks:
    - name: Verify OpenClaw installation
      stat:
        path: "{{ openclaw_home }}/.local/bin/openclaw"
      register: openclaw_verify
      tags:
        - always

    - name: Display OpenClaw installation status
      debug:
        msg: "OpenClaw successfully installed at {{ openclaw_home }}/.local/bin/openclaw"
      when: openclaw_verify.stat.exists
      tags:
        - always

    - name: Check OpenClaw service status
      systemd:
        name: openclaw
      register: openclaw_service
      tags:
        - always

    - name: Display OpenClaw service status
      debug:
        msg: |
          Service: {{ openclaw_service.name }}
          State: {{ openclaw_service.status.ActiveState }}
          Enabled: {{ 'yes' if openclaw_service.status.UnitFileState == 'enabled' else 'no' }}
      when: openclaw_service is defined
      tags:
        - always

    - name: Display next steps
      debug:
        msg: "OpenClaw provisioning complete. See README for next steps."
      tags:
        - always
