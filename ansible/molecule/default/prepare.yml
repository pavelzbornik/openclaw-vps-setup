---
# Molecule prepare playbook
# Sets up the test environment before running the main playbook

- name: Prepare test environment
  hosts: all
  become: true
  gather_facts: false

  tasks:
    - name: Wait for systemd to be ready
      wait_for_connection:
        timeout: 60

    - name: Check if python3 is already available
      raw: python3 --version
      changed_when: false
      failed_when: false
      register: python3_check

    - name: Install Python3 for Ansible
      raw: DEBIAN_FRONTEND=noninteractive apt-get install -y python3 python3-apt sudo
      changed_when: false
      when: python3_check.rc != 0

    - name: Gather facts after Python installation
      setup:

    - name: Create openclaw user for testing
      user:
        name: openclaw
        groups: sudo
        append: true
        shell: /bin/bash
        create_home: true
        state: present

    - name: Allow openclaw user to sudo without password
      copy:
        content: "openclaw ALL=(ALL) NOPASSWD: ALL\n"
        dest: /etc/sudoers.d/openclaw
        mode: '0440'
        validate: 'visudo -cf %s'
