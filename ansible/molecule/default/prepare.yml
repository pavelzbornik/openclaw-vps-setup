---
# Molecule prepare playbook
# Sets up the test environment before running the main playbook

- name: Prepare test environment
  hosts: all
  become: true
  gather_facts: false

  tasks:
    - name: Wait for systemd to be ready
      wait_for_connection:
        timeout: 60

    - name: Check if Ansible Python prerequisites are installed
      raw: dpkg -s python3 python3-apt sudo >/dev/null 2>&1
      changed_when: false
      failed_when: false
      register: ansible_prereq_check

    - name: Install Python prerequisites for Ansible
      raw: DEBIAN_FRONTEND=noninteractive apt-get install -y python3 python3-apt sudo
      changed_when: false
      when: ansible_prereq_check.rc != 0

    - name: Clean apt cache to prevent stale package errors
      raw: apt-get clean
      changed_when: false

    - name: Gather facts after Python installation
      setup:

    - name: Create openclaw user for testing
      user:
        name: openclaw
        groups: sudo
        append: true
        shell: /bin/bash
        create_home: true
        state: present

    - name: Allow openclaw user to sudo without password
      copy:
        content: "openclaw ALL=(ALL) NOPASSWD: ALL\n"
        dest: /etc/sudoers.d/openclaw
        mode: '0440'
        validate: 'visudo -cf %s'
