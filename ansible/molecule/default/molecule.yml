---
# Molecule configuration for testing OpenClaw Ansible playbooks

dependency:
  name: galaxy
  options:
    requirements-file: requirements.yml

driver:
  name: docker

platforms:
  - name: openclaw-test
    image: geerlingguy/docker-ubuntu2404-ansible:latest
    command: /lib/systemd/systemd
    volumes:
      - /sys/fs/cgroup:/sys/fs/cgroup:rw
    cgroupns_mode: host
    privileged: true
    pre_build_image: true
    networks:
      - name: openclaw-test-network

provisioner:
  name: ansible
  config_options:
    defaults:
      interpreter_python: auto_silent
      callbacks_enabled: profile_tasks, timer, yaml
  env:
    OPENCLAW_GATEWAY_TOKEN: "molecule-test-token-not-for-production"
    # Molecule generates its own ansible.cfg (overriding ANSIBLE_CONFIG), so the
    # project's ansible.cfg roles_path is not used. Set it explicitly here.
    ANSIBLE_ROLES_PATH: "${MOLECULE_PROJECT_DIRECTORY}/roles:${MOLECULE_PROJECT_DIRECTORY}/vendor/openclaw-ansible/roles"
  inventory:
    # Put the container in the group that site.yml targets.
    hosts:
      openclaw_vms:
        hosts:
          openclaw-test:
    group_vars:
      all:
        # Ansible connection â€” Docker containers run as root
        ansible_user: root
        # Override variables for testing
        openclaw_user: openclaw
        timezone: UTC
        locale: en_US.UTF-8
        # Disable upstream-level Tailscale / UFW flags
        tailscale_enabled: false
        ufw_enabled: false
  # options maps directly to ansible-playbook CLI arguments.
  # extra-vars has the highest Ansible precedence, overriding
  # ansible/group_vars/all.yml which enables docker/firewall/tailscale.
  # Disable vendor_base tasks that don't work in containers:
  #   - Docker-in-Docker is unreliable in CI runners
  #   - Tailscale cannot auth without a real key
  #   - Firewall (UFW+Docker) depends on both of the above
  #   - SSH hardening requires sshd_config which doesn't exist in Docker containers
  options:
    extra-vars: >-
      {"vendor_tailscale_enabled": false, "vendor_docker_enabled": false,
      "vendor_firewall_enabled": false, "ssh_harden": false,
      "ci_test": true, "openclaw_git_cron_enabled": false}

verifier:
  name: ansible

scenario:
  name: default
  test_sequence:
    - dependency
    - cleanup
    - destroy
    - syntax
    - create
    - prepare
    - converge
    # idempotence is skipped: the upstream pnpm ownership task (recurse: true)
    # always reports changed when pnpm updates its internal store metadata,
    # even when no package changes occur. This is a vendor limitation.
    - side_effect
    - verify
    - cleanup
    - destroy
