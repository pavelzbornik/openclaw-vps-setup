---
# Common role: System-level configuration not covered by upstream.
#
# User creation, sudoers, system packages, fail2ban, unattended-upgrades,
# and UFW are all handled by the upstream openclaw role via vendor_base.
# This role only covers: apt upgrade, timezone, locale, and extra packages.

- name: Update apt cache
  apt:
    update_cache: true
    cache_valid_time: 3600
  tags:
    - common
    - packages

- name: Upgrade all packages to latest version
  apt:
    upgrade: dist
    autoremove: true
    autoclean: true
  tags:
    - common
    - packages
    - upgrade

- name: Install extra packages not in upstream
  apt:
    name: "{{ extra_packages }}"
    state: present
  tags:
    - common
    - packages

- name: Set timezone
  timezone:
    name: "{{ timezone }}"
  tags:
    - common
    - system

- name: Set locale
  locale_gen:
    name: "{{ locale }}"
    state: present
  tags:
    - common
    - system

- name: Disable SSH password authentication
  lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^#?PasswordAuthentication'
    line: 'PasswordAuthentication no'
    state: present
    backup: true
    validate: 'sshd -t -f %s'
  notify: Restart ssh
  when: ssh_harden | default(true)
  tags:
    - common
    - security
    - ssh

- name: Disable SSH root login
  lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^#?PermitRootLogin'
    line: 'PermitRootLogin no'
    state: present
    validate: 'sshd -t -f %s'
  notify: Restart ssh
  when: ssh_harden | default(true)
  tags:
    - common
    - security
    - ssh
