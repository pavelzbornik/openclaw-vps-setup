---
# OpenClaw git sync + migration role
#
# Directory structure (~/.openclaw/) is created by upstream via vendor_base.
# This role handles: git repo clone, workspace/skills migration, sync script.

- name: Install GitHub CLI
  apt:
    name: gh
    state: present
    update_cache: true
  when:
    - openclaw_git_sync_enabled | bool
    - not (ci_test | default(false))
  tags:
    - openclaw
    - git

- name: Check for GitHub CLI
  command: which gh
  register: openclaw_git_gh_installed
  changed_when: false
  failed_when: false
  tags:
    - openclaw
    - git

- name: Read GitHub token from 1Password (if available)
  command: >-
    op read "op://{{ openclaw_github_token_vault }}/{{ openclaw_github_token_item }}/{{ openclaw_github_token_field }}"
  environment:
    OP_SERVICE_ACCOUNT_TOKEN: "{{ openclaw_op_service_account_token }}"
  register: openclaw_git_github_token
  changed_when: false
  failed_when: false
  no_log: true
  when:
    - openclaw_git_sync_enabled | bool
    - openclaw_op_service_account_token | length > 0
  tags:
    - openclaw
    - git
    - 1password

- name: Set GitHub token fact
  set_fact:
    openclaw_git_github_token_value: "{{ openclaw_git_github_token.stdout | trim }}"
  no_log: true
  when:
    - openclaw_git_sync_enabled | bool
    - openclaw_git_github_token is defined
    - openclaw_git_github_token.rc | default(1) == 0
  tags:
    - openclaw
    - git

- name: Set effective config repo URL for authenticated git operations
  set_fact:
    openclaw_git_repo_url_effective: >-
      {{
        openclaw_config_repo
        | regex_replace('^https://', 'https://x-access-token:' ~ openclaw_git_github_token_value ~ '@')
      }}
  no_log: true
  when:
    - openclaw_git_sync_enabled | bool
    - openclaw_git_github_token_value is defined
    - openclaw_git_github_token_value | length > 0
    - openclaw_config_repo is match('^https://')
  tags:
    - openclaw
    - git

- name: Set effective config repo URL for unauthenticated git operations
  set_fact:
    openclaw_git_repo_url_effective: "{{ openclaw_config_repo }}"
  when:
    - openclaw_git_sync_enabled | bool
    - openclaw_git_repo_url_effective is not defined
  tags:
    - openclaw
    - git

- name: Configure git credential helper for HTTPS auth
  become: true
  become_user: "{{ openclaw_user }}"
  community.general.git_config:
    name: credential.helper
    value: store
    scope: global
  when:
    - openclaw_git_sync_enabled | bool
    - openclaw_git_github_token_value is defined
    - openclaw_git_github_token_value | length > 0
  tags:
    - openclaw
    - git

- name: Store GitHub token in git credentials
  become: true
  become_user: "{{ openclaw_user }}"
  copy:
    dest: "{{ openclaw_home }}/.git-credentials"
    owner: "{{ openclaw_user }}"
    group: "{{ openclaw_user }}"
    mode: '0600'
    content: "https://x-access-token:{{ openclaw_git_github_token_value }}@github.com\n"
  no_log: true
  when:
    - openclaw_git_sync_enabled | bool
    - openclaw_git_github_token_value is defined
    - openclaw_git_github_token_value | length > 0
  tags:
    - openclaw
    - git

- name: Authenticate GitHub CLI for git operations
  become: true
  become_user: "{{ openclaw_user }}"
  command: gh auth login --with-token
  args:
    stdin: "{{ openclaw_git_github_token_value }}"
  register: openclaw_git_gh_auth_result
  changed_when: false
  failed_when: false
  when:
    - openclaw_git_sync_enabled | bool
    - openclaw_git_gh_installed.rc == 0
    - openclaw_git_github_token_value is defined
    - openclaw_git_use_gh_cli_auth | default(false)
  tags:
    - openclaw
    - git

- name: Warn when GitHub CLI auth fails
  debug:
    msg: >-
      GitHub CLI authentication failed (rc={{ openclaw_git_gh_auth_result.rc | default('unknown') }}).
      {{ openclaw_git_gh_auth_result.stderr | default('') | trim }}
      Continuing without gh auth; private repository operations may fail.
  when:
    - openclaw_git_sync_enabled | bool
    - openclaw_git_gh_auth_result is defined
    - openclaw_git_gh_auth_result.rc | default(1) != 0
    - openclaw_git_use_gh_cli_auth | default(false)
  tags:
    - openclaw
    - git

- name: Configure git to use GitHub CLI auth
  become: true
  become_user: "{{ openclaw_user }}"
  command: gh auth setup-git
  register: openclaw_git_gh_setup_git_result
  changed_when: false
  failed_when: false
  when:
    - openclaw_git_sync_enabled | bool
    - openclaw_git_gh_installed.rc == 0
    - openclaw_git_github_token_value is defined
    - openclaw_git_gh_auth_result is defined
    - openclaw_git_gh_auth_result.rc | default(1) == 0
    - openclaw_git_use_gh_cli_auth | default(false)
  tags:
    - openclaw
    - git

- name: Reset temp repo path
  file:
    path: "{{ openclaw_git_tmp_dir }}"
    state: absent
  when: openclaw_git_sync_enabled | bool
  tags:
    - openclaw
    - git

- name: Clone config repo to temp for migration detection
  git:  # noqa: latest[git] — intentionally pulls HEAD of the user's config repo
    repo: "{{ openclaw_git_repo_url_effective }}"
    dest: "{{ openclaw_git_tmp_dir }}"
    version: HEAD
    depth: 1
    update: true
    force: true
  environment:
    GIT_TERMINAL_PROMPT: "0"
  register: openclaw_git_tmp_clone
  failed_when: false
  when: openclaw_git_sync_enabled | bool
  tags:
    - openclaw
    - git

- name: Bootstrap empty config repository with initial commit
  become: true
  become_user: "{{ openclaw_user }}"
  shell: |
    set -eu
    bootstrap_dir="{{ openclaw_git_tmp_dir }}-bootstrap"
    rm -rf "$bootstrap_dir"
    mkdir -p "$bootstrap_dir"
    cd "$bootstrap_dir"
    git init
    git config user.name "openclaw-bootstrap"
    git config user.email "openclaw-bootstrap@localhost"
    echo "# OpenClaw Config" > README.md
    git add README.md
    git commit -m "Initialize config repository"
    git branch -M main
    git remote add origin "{{ openclaw_git_repo_url_effective }}"
    git push -u origin main
    rm -rf "$bootstrap_dir"
  args:
    executable: /bin/bash
  no_log: true
  register: openclaw_git_bootstrap_result
  changed_when: openclaw_git_bootstrap_result.rc == 0
  failed_when: false
  when:
    - openclaw_git_sync_enabled | bool
    - openclaw_git_tmp_clone is defined
    - openclaw_git_tmp_clone.rc | default(1) != 0
    - (openclaw_git_tmp_clone.stderr | default('')) is search("pathspec 'main'")
  tags:
    - openclaw
    - git

- name: Retry temp clone after repository bootstrap
  git:  # noqa: latest[git] — intentionally pulls HEAD of the user's config repo
    repo: "{{ openclaw_git_repo_url_effective }}"
    dest: "{{ openclaw_git_tmp_dir }}"
    version: HEAD
    depth: 1
    update: true
    force: true
  environment:
    GIT_TERMINAL_PROMPT: "0"
  register: openclaw_git_tmp_clone_retry
  failed_when: false
  when:
    - openclaw_git_sync_enabled | bool
    - openclaw_git_bootstrap_result is defined
    - openclaw_git_bootstrap_result.rc | default(1) == 0
  tags:
    - openclaw
    - git

- name: Use retried temp clone result
  set_fact:
    openclaw_git_tmp_clone: "{{ openclaw_git_tmp_clone_retry }}"
  when:
    - openclaw_git_tmp_clone_retry is defined
  tags:
    - openclaw
    - git

- name: Check for workspace files in temp repo
  find:
    paths: "{{ openclaw_git_tmp_dir }}/workspace"
    file_type: file
  register: openclaw_git_tmp_workspace
  failed_when: false
  when:
    - openclaw_git_sync_enabled | bool
    - openclaw_git_tmp_clone is defined
    - openclaw_git_tmp_clone.after is defined
  tags:
    - openclaw
    - git

- name: Set migration mode
  set_fact:
    openclaw_git_migration_mode: "{{ (openclaw_git_tmp_workspace.matched | default(0)) | int > 0 }}"
  when: openclaw_git_sync_enabled | bool
  tags:
    - openclaw
    - git

- name: Cleanup temp clone
  file:
    path: "{{ openclaw_git_tmp_dir }}"
    state: absent
  when: openclaw_git_sync_enabled | bool
  tags:
    - openclaw
    - git

- name: Clone config repo to destination
  become: true
  become_user: "{{ openclaw_user }}"
  git:  # noqa: latest[git] — intentionally pulls HEAD of the user's config repo
    repo: "{{ openclaw_git_repo_url_effective }}"
    dest: "{{ openclaw_config_repo_dest }}"
    version: HEAD
    update: true
  environment:
    GIT_TERMINAL_PROMPT: "0"
  register: openclaw_git_dest_clone
  failed_when: false
  when:
    - openclaw_git_sync_enabled | bool
  tags:
    - openclaw
    - git

- name: Mark repo availability
  set_fact:
    openclaw_git_repo_available: "{{ not (openclaw_git_dest_clone.failed | default(false)) }}"
  when: openclaw_git_sync_enabled | bool
  tags:
    - openclaw
    - git

- name: Report git sync status
  debug:
    msg: >-
      Git sync status: {{ 'enabled' if openclaw_git_sync_enabled else 'disabled' }};
      migration={{ openclaw_git_migration_mode | default(false) }};
      repo={{ 'available' if openclaw_git_repo_available | default(false) else 'unavailable' }}
  tags:
    - openclaw
    - git

- name: Ensure repo workspace directory exists
  file:
    path: "{{ openclaw_config_repo_dest }}/workspace"
    state: directory
    owner: "{{ openclaw_user }}"
    group: "{{ openclaw_user }}"
    mode: '0755'
  when:
    - openclaw_git_repo_available | default(false)
  tags:
    - openclaw
    - git

- name: Ensure repo skills directory exists
  file:
    path: "{{ openclaw_config_repo_dest }}/skills"
    state: directory
    owner: "{{ openclaw_user }}"
    group: "{{ openclaw_user }}"
    mode: '0755'
  when:
    - openclaw_git_repo_available | default(false)
  tags:
    - openclaw
    - git

- name: Ensure OpenClaw workspace directory exists
  file:
    path: "{{ openclaw_config_dir }}/workspace"
    state: directory
    owner: "{{ openclaw_user }}"
    group: "{{ openclaw_user }}"
    mode: '0750'
  when:
    - openclaw_git_repo_available | default(false)
  tags:
    - openclaw
    - git

- name: Check configured workspace source directory in config repo
  stat:
    path: "{{ openclaw_workspace_repo_path }}"
  register: openclaw_git_workspace_source_dir
  when:
    - openclaw_git_repo_available | default(false)
    - openclaw_workspace_source == "private_repo"
  tags:
    - openclaw
    - git

- name: Check personal workspace files in config repo
  stat:
    path: "{{ openclaw_workspace_repo_path }}/{{ item }}"
  loop: "{{ openclaw_workspace_personal_files }}"
  register: openclaw_git_workspace_file_stats
  when:
    - openclaw_git_repo_available | default(false)
    - openclaw_workspace_source == "private_repo"
    - openclaw_git_workspace_source_dir is defined
    - openclaw_git_workspace_source_dir.stat is defined
    - openclaw_git_workspace_source_dir.stat.isdir | default(false)
  tags:
    - openclaw
    - git

- name: Deploy personal workspace files from config repo
  copy:
    src: "{{ item.stat.path }}"
    dest: "{{ openclaw_config_dir }}/workspace/{{ item.item }}"
    owner: "{{ openclaw_user }}"
    group: "{{ openclaw_user }}"
    mode: '0640'
    remote_src: true
    force: true
  loop: "{{ openclaw_git_workspace_file_stats.results | default([]) }}"
  when:
    - openclaw_git_repo_available | default(false)
    - openclaw_workspace_source == "private_repo"
    - item.stat is defined
    - item.stat.exists | default(false)
  tags:
    - openclaw
    - git

- name: Write default .gitignore for config repo
  copy:
    dest: "{{ openclaw_config_repo_dest }}/.gitignore"
    owner: "{{ openclaw_user }}"
    group: "{{ openclaw_user }}"
    mode: '0644'
    force: false
    content: |
      # Secrets - NEVER commit these
      credentials/
      *.token
      *.key
      *.secret
      .env
      secrets.yml
      openclaw.json

      # Session data - contains private conversations
      sessions/
      *.session

      # Logs - may contain sensitive info
      logs/
      *.log

      # Memory - may contain personal information
      MEMORY.md

      # Temporary files
      *.tmp
      *.swp
      *~
      .DS_Store

      # Keep directory structure
      !credentials/.gitkeep
      !sessions/.gitkeep
      !logs/.gitkeep
  when:
    - openclaw_git_repo_available | default(false)
  tags:
    - openclaw
    - git

- name: Create config template in repo (new install)
  template:
    src: openclaw.json.j2
    dest: "{{ openclaw_config_repo_dest }}/openclaw.json.template"
    owner: "{{ openclaw_user }}"
    group: "{{ openclaw_user }}"
    mode: '0644'
    force: true
  when:
    - openclaw_git_repo_available | default(false)
    - not (openclaw_git_migration_mode | default(false))
  tags:
    - openclaw
    - git

- name: Check config repo working tree status  # noqa: command-instead-of-module
  become: true
  become_user: "{{ openclaw_user }}"
  command: git -C "{{ openclaw_config_repo_dest }}" status --porcelain
  register: openclaw_git_repo_status
  changed_when: false
  failed_when: false
  when:
    - openclaw_git_repo_available | default(false)
  tags:
    - openclaw
    - git

- name: Commit initial config scaffold
  become: true
  become_user: "{{ openclaw_user }}"
  shell: |
    set -e
    git -C "{{ openclaw_config_repo_dest }}" add .
    git -C "{{ openclaw_config_repo_dest }}" \
      -c user.name="openclaw-bootstrap" \
      -c user.email="openclaw-bootstrap@localhost" \
      commit -m "Initialize OpenClaw config scaffold"
  args:
    executable: /bin/bash
  register: openclaw_git_initial_commit
  changed_when: openclaw_git_initial_commit.rc == 0
  failed_when: false
  when:
    - openclaw_git_repo_available | default(false)
    - not (openclaw_git_migration_mode | default(false))
    - openclaw_git_repo_status is defined
    - (openclaw_git_repo_status.stdout | default('') | trim) | length > 0
  tags:
    - openclaw
    - git

- name: Push initial config scaffold commit  # noqa: command-instead-of-module
  become: true
  become_user: "{{ openclaw_user }}"
  command: git -C "{{ openclaw_config_repo_dest }}" push
  register: openclaw_git_initial_push
  changed_when: openclaw_git_initial_push.rc == 0
  failed_when: false
  when:
    - openclaw_git_initial_commit is defined
    - openclaw_git_initial_commit.rc | default(1) == 0
  tags:
    - openclaw
    - git

- name: Copy workspace from repo (migration)
  copy:
    src: "{{ openclaw_config_repo_dest }}/workspace/"
    dest: "{{ openclaw_config_dir }}/workspace/"
    owner: "{{ openclaw_user }}"
    group: "{{ openclaw_user }}"
    mode: preserve
    directory_mode: '0755'
    remote_src: true
  when:
    - openclaw_git_repo_available | default(false)
    - openclaw_git_migration_mode | default(false)
  tags:
    - openclaw
    - git
    - migration

- name: Check repo skills directory
  stat:
    path: "{{ openclaw_config_repo_dest }}/skills"
  register: openclaw_git_repo_skills
  when:
    - openclaw_git_repo_available | default(false)
  tags:
    - openclaw
    - git

- name: Copy skills from repo (migration)
  copy:
    src: "{{ openclaw_config_repo_dest }}/skills/"
    dest: "{{ openclaw_config_dir }}/skills/"
    owner: "{{ openclaw_user }}"
    group: "{{ openclaw_user }}"
    mode: preserve
    directory_mode: '0755'
    remote_src: true
  when:
    - openclaw_git_repo_available | default(false)
    - openclaw_git_repo_skills is defined
    - openclaw_git_repo_skills.stat is defined
    - openclaw_git_repo_skills.stat.exists
    - openclaw_git_migration_mode | default(false)
  tags:
    - openclaw
    - git
    - migration

- name: Check config template in repo
  stat:
    path: "{{ openclaw_config_repo_dest }}/openclaw.json.template"
  register: openclaw_git_repo_template
  when:
    - openclaw_git_repo_available | default(false)
  tags:
    - openclaw
    - git

- name: Inject secrets to create openclaw.json (migration)
  command: >-
    op inject -i "{{ openclaw_config_repo_dest }}/openclaw.json.template" -o "{{ openclaw_config_dir }}/openclaw.json"
  environment:
    OP_SERVICE_ACCOUNT_TOKEN: "{{ openclaw_op_service_account_token }}"
  changed_when: true  # always writes the secrets-injected config file when run
  no_log: true
  when:
    - openclaw_git_repo_available | default(false)
    - openclaw_git_repo_template is defined
    - openclaw_git_repo_template.stat is defined
    - openclaw_git_repo_template.stat.exists
    - openclaw_op_service_account_token | length > 0
    - openclaw_git_migration_mode | default(false)
  tags:
    - openclaw
    - git
    - migration
    - 1password

- name: Secure injected openclaw.json permissions
  file:
    path: "{{ openclaw_config_dir }}/openclaw.json"
    owner: "{{ openclaw_user }}"
    group: "{{ openclaw_user }}"
    mode: '0600'
  when:
    - openclaw_git_repo_available | default(false)
    - openclaw_git_repo_template is defined
    - openclaw_git_repo_template.stat is defined
    - openclaw_git_repo_template.stat.exists
    - openclaw_op_service_account_token | length > 0
    - openclaw_git_migration_mode | default(false)
  tags:
    - openclaw
    - git
    - migration
    - 1password

- name: Install sync script
  copy:
    dest: "{{ openclaw_home }}/sync-openclaw-config.sh"
    owner: "{{ openclaw_user }}"
    group: "{{ openclaw_user }}"
    mode: '0755'
    content: |
      #!/bin/bash
      # Sync OpenClaw configuration to git
      set -e

      CONFIG_REPO="{{ openclaw_config_repo_dest }}"
      OPENCLAW_DIR="{{ openclaw_config_dir }}"

      cd "$CONFIG_REPO"

      git pull --rebase || { echo "ERROR: git pull failed — resolve conflicts manually"; exit 1; }

      echo "Backing up workspace files..."
      rsync -av --exclude='MEMORY.md' \
          "$OPENCLAW_DIR/workspace/" "$CONFIG_REPO/workspace/"

      if [ -d "$OPENCLAW_DIR/skills" ]; then
          echo "Backing up global skills..."
          rsync -av "$OPENCLAW_DIR/skills/" "$CONFIG_REPO/skills/"
      fi

      if [ -f "$OPENCLAW_DIR/openclaw.json" ]; then
          if [ ! -f "$CONFIG_REPO/openclaw.json.template" ]; then
            echo "Config template missing; create it manually to avoid committing secrets."
          fi
      fi

      if [ -n "$(git status --porcelain)" ]; then
          git add .
          git commit -m "Auto-sync: $(date '+%Y-%m-%d %H:%M:%S')"
          git push
          echo "Configuration synced to git"
      else
          echo "No changes to sync"
      fi
  when:
    - openclaw_git_repo_available | default(false)
  tags:
    - openclaw
    - git

- name: Install systemd service for config sync
  copy:
    dest: /etc/systemd/system/openclaw-backup.service
    owner: root
    group: root
    mode: '0644'
    content: |
      [Unit]
      Description=Backup OpenClaw configuration to git

      [Service]
      Type=oneshot
      User={{ openclaw_user }}
      WorkingDirectory={{ openclaw_config_repo_dest }}
      ExecStart={{ openclaw_home }}/sync-openclaw-config.sh
      TimeoutStartSec=300
  when:
    - openclaw_git_repo_available | default(false)
  tags:
    - openclaw
    - git

- name: Install systemd timer for config sync
  copy:
    dest: /etc/systemd/system/openclaw-backup.timer
    owner: root
    group: root
    mode: '0644'
    content: |
      [Unit]
      Description=Daily OpenClaw configuration backup

      [Timer]
      OnCalendar=daily
      OnBootSec=15min
      Persistent=true

      [Install]
      WantedBy=timers.target
  when:
    - openclaw_git_repo_available | default(false)
    - openclaw_git_timer_enabled | bool
    - not (openclaw_git_cron_enabled | default(false))
  tags:
    - openclaw
    - git

- name: Enable config sync timer
  systemd:
    name: openclaw-backup.timer
    enabled: true
    state: started
    daemon_reload: true
  when:
    - openclaw_git_repo_available | default(false)
    - openclaw_git_timer_enabled | bool
    - not (openclaw_git_cron_enabled | default(false))
  tags:
    - openclaw
    - git

- name: Disable config sync timer when cron scheduling is enabled
  systemd:
    name: openclaw-backup.timer
    enabled: false
    state: stopped
    daemon_reload: true
  failed_when: false
  when:
    - openclaw_git_repo_available | default(false)
    - openclaw_git_cron_enabled | default(false)
  tags:
    - openclaw
    - git

- name: Check if crontab command is available
  stat:
    path: /usr/bin/crontab
  register: openclaw_git_crontab_bin
  when:
    - openclaw_git_repo_available | default(false)
    - openclaw_git_cron_enabled | default(false)
  tags:
    - openclaw
    - git
    - cron

- name: Install cron job for regular OpenClaw config sync
  cron:
    name: "OpenClaw config sync"
    user: "{{ openclaw_user }}"
    minute: "{{ openclaw_git_cron_minute | default('17') }}"
    hour: "{{ openclaw_git_cron_hour | default('*/6') }}"
    job: >-
      /usr/bin/flock -n {{ openclaw_home }}/.sync-openclaw-config.lock
      {{ openclaw_home }}/sync-openclaw-config.sh
      >> {{ openclaw_home }}/sync-openclaw-config.log 2>&1
    state: "{{ 'present' if (openclaw_git_cron_enabled | default(false)) else 'absent' }}"
  when:
    - openclaw_git_repo_available | default(false)
    - not (ci_test | default(false))
    - openclaw_git_crontab_bin is defined
    - openclaw_git_crontab_bin.stat is defined
    - openclaw_git_crontab_bin.stat.exists | default(false)
  tags:
    - openclaw
    - git
    - cron
