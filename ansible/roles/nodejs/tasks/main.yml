---
# Node.js role: Install Node.js 20.x from NodeSource

- name: Check if NodeSource repository is already configured
  stat:
    path: /etc/apt/sources.list.d/nodesource.list
  register: nodesource_repo
  tags:
    - nodejs

- name: Download NodeSource setup script
  get_url:
    url: "https://deb.nodesource.com/setup_{{ nodejs_version }}.x"
    dest: /tmp/nodesource_setup.sh
    mode: '0755'
  when: not nodesource_repo.stat.exists
  tags:
    - nodejs

- name: Run NodeSource setup script
  command: bash /tmp/nodesource_setup.sh
  args:
    creates: /etc/apt/sources.list.d/nodesource.list
  when: not nodesource_repo.stat.exists
  tags:
    - nodejs

- name: Update apt cache after NodeSource setup
  apt:
    update_cache: yes
  when: not nodesource_repo.stat.exists
  tags:
    - nodejs

- name: Install Node.js
  apt:
    name: nodejs
    state: present
  tags:
    - nodejs
    - packages

- name: Verify Node.js installation
  command: node --version
  register: node_version
  changed_when: false
  tags:
    - nodejs

- name: Verify npm installation
  command: npm --version
  register: npm_version
  changed_when: false
  tags:
    - nodejs

- name: Display Node.js version
  debug:
    msg: "Node.js version: {{ node_version.stdout }}"
  tags:
    - nodejs

- name: Display npm version
  debug:
    msg: "npm version: {{ npm_version.stdout }}"
  tags:
    - nodejs

- name: Create npm global directory for user
  file:
    path: "{{ openclaw_home }}/.npm-global"
    state: directory
    owner: "{{ openclaw_user }}"
    group: "{{ openclaw_group }}"
    mode: '0755'
  tags:
    - nodejs

- name: Configure npm to use user global directory
  become: yes
  become_user: "{{ openclaw_user }}"
  command: npm config set prefix '{{ openclaw_home }}/.npm-global'
  args:
    creates: "{{ openclaw_home }}/.npmrc"
  tags:
    - nodejs

- name: Add npm global bin to PATH in .bashrc
  lineinfile:
    path: "{{ openclaw_home }}/.bashrc"
    line: 'export PATH="{{ openclaw_home }}/.npm-global/bin:$PATH"'
    create: yes
    owner: "{{ openclaw_user }}"
    group: "{{ openclaw_group }}"
    mode: '0644'
  tags:
    - nodejs
