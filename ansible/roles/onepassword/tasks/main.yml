---
# 1Password CLI role: Install and configure 1Password CLI

- name: Check if 1Password CLI is already installed
  command: which op
  register: onepassword_op_installed
  changed_when: false
  failed_when: false
  tags:
    - onepassword

- name: Download 1Password CLI
  get_url:
    url: "{{ onepassword_cli_deb_url }}"
    dest: /tmp/1password-cli.deb
    mode: '0644'
  when: onepassword_op_installed.rc != 0
  tags:
    - onepassword

- name: Install 1Password CLI
  apt:
    deb: /tmp/1password-cli.deb
    state: present
  when: onepassword_op_installed.rc != 0
  tags:
    - onepassword

- name: Verify 1Password CLI installation
  command: op --version
  register: onepassword_op_version
  changed_when: false
  tags:
    - onepassword

- name: Display 1Password CLI version
  debug:
    msg: "1Password CLI version: {{ onepassword_op_version.stdout }}"
  tags:
    - onepassword

- name: Require OP service account token for 1Password-backed deploy
  assert:
    that:
      - openclaw_op_service_account_token | default('') | length > 0
    fail_msg: >-
      OP service account token is required. Set vault_openclaw_op_service_account_token
      in group_vars/vault.yml and re-run deploy.
  tags:
    - onepassword

- name: Test 1Password connection (if token available)
  command: op vault list
  environment:
    OP_SERVICE_ACCOUNT_TOKEN: "{{ openclaw_op_service_account_token }}"
  register: onepassword_op_vaults
  changed_when: false
  failed_when: false
  when: openclaw_op_service_account_token | default('') | length > 0
  tags:
    - onepassword

- name: Display available vaults
  debug:
    msg: "{{ onepassword_op_vaults.stdout_lines }}"
  when:
    - openclaw_op_service_account_token | default('') | length > 0
    - onepassword_op_vaults.rc == 0
  tags:
    - onepassword
