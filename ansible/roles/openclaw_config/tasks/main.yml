---
# OpenClaw local role: config templating + systemd service for unattended deploys.
#
# Upstream (via vendor_base) handles: user creation, pnpm dirs, pnpm install,
# .bashrc PATH, .openclaw/ directory structure.
# This role only adds what upstream doesn't: pre-baked config files, systemd
# service, logrotate, and optional onboard/doctor commands.

- name: Get Tailscale IPv4 address for gateway bind
  command: tailscale ip -4
  register: openclaw_config_tailscale_ip_result
  changed_when: false
  failed_when: false
  when: tailscale_enabled | default(false)
  tags:
    - openclaw
    - config

- name: Render OpenClaw environment source with 1Password references
  template:
    src: openclaw.env.j2
    dest: "{{ openclaw_config_dir }}/.env.op"
    owner: "{{ openclaw_user }}"
    group: "{{ openclaw_user }}"
    mode: '0600'
  tags:
    - openclaw
    - config

- name: Populate OpenClaw environment file via op inject
  become: true
  become_user: "{{ openclaw_user }}"
  command: >-
    op inject
    --in-file "{{ openclaw_config_dir }}/.env.op"
    --out-file "{{ openclaw_config_dir }}/.env"
  environment:
    OP_SERVICE_ACCOUNT_TOKEN: "{{ openclaw_op_service_account_token }}"
  no_log: true
  notify:
    - Restart openclaw
  when:
    - not (ci_test | default(false))
  tags:
    - openclaw
    - config
    - 1password

- name: Deploy OpenClaw environment file
  file:
    path: "{{ openclaw_config_dir }}/.env"
    owner: "{{ openclaw_user }}"
    group: "{{ openclaw_user }}"
    mode: '0600'
    state: touch
  tags:
    - openclaw
    - config

- name: Remove temporary OpenClaw environment source file
  file:
    path: "{{ openclaw_config_dir }}/.env.op"
    state: absent
    owner: "{{ openclaw_user }}"
    group: "{{ openclaw_user }}"
  tags:
    - openclaw
    - config

- name: Deploy OpenClaw configuration template
  template:
    src: openclaw.json.j2
    dest: "{{ openclaw_config_dir }}/openclaw.json"
    owner: "{{ openclaw_user }}"
    group: "{{ openclaw_user }}"
    mode: '0600'
    force: true
  notify:
    - Restart openclaw
  tags:
    - openclaw
    - config

- name: Run OpenClaw onboarding to install daemon
  become: true
  become_user: "{{ openclaw_user }}"
  command: "{{ openclaw_home }}/.local/bin/openclaw onboard --install-daemon"
  environment:
    PNPM_HOME: "{{ openclaw_home }}/.local/share/pnpm"
    PATH: "{{ openclaw_home }}/.local/bin:{{ openclaw_home }}/.local/share/pnpm:/usr/local/bin:/usr/bin:/bin"
    HOME: "{{ openclaw_home }}"
  register: openclaw_config_onboard
  changed_when: "'already' not in openclaw_config_onboard.stdout | lower"
  ignore_errors: true
  when: openclaw_app_onboard_install_daemon | default(false)
  tags:
    - openclaw
    - install

- name: Verify OpenClaw installation with doctor command
  become: true
  become_user: "{{ openclaw_user }}"
  command: "timeout 30s {{ openclaw_home }}/.local/bin/openclaw doctor"
  environment:
    PNPM_HOME: "{{ openclaw_home }}/.local/share/pnpm"
    PATH: "{{ openclaw_home }}/.local/bin:{{ openclaw_home }}/.local/share/pnpm:/usr/local/bin:/usr/bin:/bin"
    HOME: "{{ openclaw_home }}"
  register: openclaw_config_doctor
  changed_when: false
  ignore_errors: true
  when: openclaw_run_doctor | default(false)
  tags:
    - openclaw

- name: Display OpenClaw doctor output
  debug:
    msg: "{{ openclaw_config_doctor.stdout_lines }}"
  when:
    - openclaw_config_doctor is defined
    - not (openclaw_config_doctor.skipped | default(false))
    - openclaw_config_doctor.rc | default(1) == 0
    - openclaw_config_doctor.stdout_lines is defined
  tags:
    - openclaw

- name: Create systemd service file for OpenClaw
  template:
    src: openclaw.service.j2
    dest: /etc/systemd/system/openclaw.service
    owner: root
    group: root
    mode: '0644'
  notify:
    - Reload systemd
    - Restart openclaw
  tags:
    - openclaw
    - systemd

- name: Enable OpenClaw service
  systemd:
    name: openclaw
    enabled: true
    daemon_reload: true
  tags:
    - openclaw
    - systemd

- name: Create logrotate configuration for OpenClaw
  copy:
    dest: /etc/logrotate.d/openclaw
    content: |
      {{ openclaw_config_dir }}/logs/*.log {
          daily
          missingok
          rotate 14
          compress
          delaycompress
          notifempty
          copytruncate
          create 0640 {{ openclaw_user }} {{ openclaw_user }}
      }
    mode: '0644'
  tags:
    - openclaw
    - logging
