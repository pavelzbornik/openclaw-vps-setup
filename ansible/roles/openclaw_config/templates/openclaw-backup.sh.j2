#!/usr/bin/env bash
set -euo pipefail

# Source 1Password service account auth
# shellcheck source=/dev/null
source {{ openclaw_backup_env_file }}

TIMESTAMP=$(date +%s)
BACKUP_DIR="{{ openclaw_backup_dir }}"

# Fetch secrets from 1Password at runtime
PASSPHRASE=$(op read "op://{{ openclaw_backup_passphrase_vault }}/{{ openclaw_backup_passphrase_item }}/{{ openclaw_backup_passphrase_field }}")
export AWS_ACCESS_KEY_ID
AWS_ACCESS_KEY_ID=$(op read "op://{{ openclaw_aws_key_vault }}/{{ openclaw_aws_key_item }}/{{ openclaw_aws_access_key_field }}")
export AWS_SECRET_ACCESS_KEY
AWS_SECRET_ACCESS_KEY=$(op read "op://{{ openclaw_aws_key_vault }}/{{ openclaw_aws_key_item }}/{{ openclaw_aws_secret_key_field }}")
export AWS_DEFAULT_REGION="{{ openclaw_s3_region }}"

mkdir -p "${BACKUP_DIR}"
systemctl stop openclaw
trap "systemctl start openclaw" EXIT

tar -czf "${BACKUP_DIR}/openclaw-${TIMESTAMP}.tgz" -C "{{ openclaw_home }}" .openclaw

echo "${PASSPHRASE}" | openssl enc -aes-256-cbc -pbkdf2 \
  -in "${BACKUP_DIR}/openclaw-${TIMESTAMP}.tgz" \
  -out "${BACKUP_DIR}/openclaw-${TIMESTAMP}.tgz.enc" \
  -pass stdin

rm -f "${BACKUP_DIR}/openclaw-${TIMESTAMP}.tgz"

aws s3 cp "${BACKUP_DIR}/openclaw-${TIMESTAMP}.tgz.enc" \
  "s3://{{ openclaw_s3_bucket }}/{{ openclaw_s3_prefix }}/openclaw-${TIMESTAMP}.tgz.enc"

rm -f "${BACKUP_DIR}/openclaw-${TIMESTAMP}.tgz.enc"
echo "Backup complete: s3://{{ openclaw_s3_bucket }}/{{ openclaw_s3_prefix }}/openclaw-${TIMESTAMP}.tgz.enc"
