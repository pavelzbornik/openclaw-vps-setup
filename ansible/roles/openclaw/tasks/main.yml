---
# OpenClaw role: Install and configure OpenClaw

- name: Ensure npm global prefix is configured for OpenClaw user
  block:
    - name: Create npm global directory for user
      file:
        path: "{{ openclaw_home }}/.npm-global"
        state: directory
        owner: "{{ openclaw_user }}"
        group: "{{ openclaw_group }}"
        mode: '0755'

    - name: Remove npm cache directory to fix ownership issues
      file:
        path: "{{ openclaw_home }}/.npm"
        state: absent

    - name: Create empty npm cache directory with proper permissions
      file:
        path: "{{ openclaw_home }}/.npm"
        state: directory
        owner: "{{ openclaw_user }}"
        group: "{{ openclaw_group }}"
        mode: '0700'

    - name: Create .ansible/tmp directory with proper permissions
      file:
        path: "{{ openclaw_home }}/.ansible/tmp"
        state: directory
        owner: "{{ openclaw_user }}"
        group: "{{ openclaw_group }}"
        mode: '0700'

    - name: Ensure .npmrc exists
      file:
        path: "{{ openclaw_home }}/.npmrc"
        state: touch
        owner: "{{ openclaw_user }}"
        group: "{{ openclaw_group }}"
        mode: '0644'

    - name: Configure npm prefix in .npmrc
      lineinfile:
        path: "{{ openclaw_home }}/.npmrc"
        line: "prefix={{ openclaw_home }}/.npm-global"
        create: yes
        owner: "{{ openclaw_user }}"
        group: "{{ openclaw_group }}"
        mode: '0644'

    - name: Add npm global bin to PATH in .bashrc
      lineinfile:
        path: "{{ openclaw_home }}/.bashrc"
        line: 'export PATH="{{ openclaw_home }}/.npm-global/bin:$PATH"'
        create: yes
        owner: "{{ openclaw_user }}"
        group: "{{ openclaw_group }}"
        mode: '0644'
  tags:
    - openclaw
    - nodejs
    - npm

- name: Create OpenClaw directory structure
  file:
    path: "{{ item }}"
    state: directory
    owner: "{{ openclaw_user }}"
    group: "{{ openclaw_group }}"
    mode: '0755'
  loop:
    - "{{ openclaw_install_dir }}"
    - "{{ openclaw_config_dir }}"
    - "{{ openclaw_workspace_dir }}"
    - "{{ openclaw_logs_dir }}"
  tags:
    - openclaw
    - directories

- name: Install OpenClaw via npm
  become: yes
  become_user: "{{ openclaw_user }}"
  npm:
    name: "{{ openclaw_npm_package }}"
    global: yes
    state: "{{ 'latest' if openclaw_version == 'latest' else 'present' }}"
    version: "{{ omit if openclaw_version == 'latest' else openclaw_version }}"
  environment:
    PATH: "{{ openclaw_home }}/.npm-global/bin:{{ ansible_env.PATH }}"
    npm_config_prefix: "{{ openclaw_home }}/.npm-global"
  register: openclaw_npm_install
  ignore_errors: yes
  tags:
    - openclaw
    - install

- name: Run OpenClaw onboarding to install daemon
  become: yes
  become_user: "{{ openclaw_user }}"
  shell: "{{ openclaw_home }}/.npm-global/bin/openclaw onboard --install-daemon"
  environment:
    PATH: "{{ openclaw_home }}/.npm-global/bin:{{ ansible_env.PATH }}"
  register: openclaw_onboard
  changed_when: "'already' not in openclaw_onboard.stdout | lower"
  ignore_errors: yes
  when:
    - openclaw_npm_install.rc | default(0) == 0
    - openclaw_onboard_install_daemon | default(false)
  tags:
    - openclaw
    - install

- name: Display OpenClaw npm installation status
  debug:
    msg: >
      OpenClaw npm installation:
      {{ 'succeeded' if openclaw_npm_install.rc | default(0) == 0
         else 'failed - package may not be published or available' }}
  tags:
    - openclaw

- name: Display OpenClaw onboarding status
  debug:
    msg: "OpenClaw onboarding completed successfully"
  when:
    - openclaw_onboard is defined
    - not (openclaw_onboard.skipped | default(false))
    - openclaw_onboard.rc | default(0) == 0
  tags:
    - openclaw

- name: Verify OpenClaw installation with doctor command (if available)
  become: yes
  become_user: "{{ openclaw_user }}"
  shell: "{{ openclaw_home }}/.npm-global/bin/openclaw doctor"
  environment:
    PATH: "{{ openclaw_home }}/.npm-global/bin:{{ ansible_env.PATH }}"
  register: openclaw_doctor
  changed_when: false
  ignore_errors: yes
  when: openclaw_npm_install.rc | default(0) == 0
  tags:
    - openclaw

- name: Display OpenClaw doctor output
  debug:
    msg: "{{ openclaw_doctor.stdout_lines }}"
  when: openclaw_doctor is defined and openclaw_doctor.rc | default(0) == 0
  tags:
    - openclaw

- name: Create OpenClaw configuration file
  template:
    src: openclaw.json.j2
    dest: "{{ openclaw_config_dir }}/openclaw.json"
    owner: "{{ openclaw_user }}"
    group: "{{ openclaw_group }}"
    mode: '0600'
  notify: restart openclaw
  when: openclaw_npm_install.rc | default(0) == 0
  tags:
    - openclaw
    - config

- name: Create OpenClaw environment file
  template:
    src: openclaw.env.j2
    dest: "{{ openclaw_install_dir }}/.env"
    owner: "{{ openclaw_user }}"
    group: "{{ openclaw_group }}"
    mode: '0600'
  notify: restart openclaw
  tags:
    - openclaw
    - config

- name: Create systemd service file for OpenClaw
  template:
    src: openclaw.service.j2
    dest: /etc/systemd/system/openclaw.service
    owner: root
    group: root
    mode: '0644'
  notify:
    - reload systemd
    - restart openclaw
  tags:
    - openclaw
    - systemd

- name: Enable OpenClaw service
  systemd:
    name: openclaw
    enabled: yes
    daemon_reload: yes
  tags:
    - openclaw
    - systemd

- name: Create logrotate configuration for OpenClaw
  copy:
    dest: /etc/logrotate.d/openclaw
    content: |
      {{ openclaw_logs_dir }}/*.log {
          daily
          missingok
          rotate 14
          compress
          delaycompress
          notifempty
          create 0640 {{ openclaw_user }} {{ openclaw_group }}
          sharedscripts
          postrotate
              systemctl reload openclaw > /dev/null 2>&1 || true
          endscript
      }
    mode: '0644'
  tags:
    - openclaw
    - logging
